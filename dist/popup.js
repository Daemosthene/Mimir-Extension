(()=>{function e(e,t){const n={action:e,text:t};switch(e){case"Summarize":return{...n,mode:"concise",includeKeywords:!0};case"Explain Like I'm 5":return{...n,simplifyLevel:5};case"Citation Finder":return{...n,includeLinks:!0,format:"APA"};case"Definition":return{...n,includeExamples:!0,simplify:!0};case"Daily Brief":return{...n,context:"yesterday",includeTasks:!0};case"Socratic Review":return{...n,questionStyle:"dialectic",depth:"high"};case"Flashcard Generator":return{...n,format:"anki",maxCards:10};case"Turn Professional":return{...n,tone:"professional",polish:!0};case"Translate Text":return{...n,targetLanguage:"en",preserveFormat:!0};case"AI Detector":return{...n,detectAI:!0};default:return n}}const t={default:"#4287f5",red:"#A4262C",orange:"#CA5010",darkblue:"#40587C",green:"#407855",purple:"#8764B8",teal:"#038387",yellow:"#CEA230",white:"#ffffff",black:"#000000"};function n(e){const n=t[e]||t.default;document.documentElement.style.setProperty("--accent-color",n),"#ffffff"===n?(document.documentElement.style.setProperty("--text-color","#ffffff"),document.querySelectorAll("body, h2, .label, .settings-title, #tagline, #openSettings, .back-button").forEach(e=>{e.style.color="#ffffff"}),document.querySelectorAll(".action-button, #enterPromptBtn, #editTextBtn, #bubbleModeBtn, #generatePromptBtn, #cancelPromptBtn").forEach(e=>{e.style.color="#000000",e.style.border="none"}),document.querySelectorAll(".action-button .span-mother span, .action-button .span-mother2 span").forEach(e=>{e.style.color="#000000"})):"#000000"===n?(document.documentElement.style.setProperty("--text-color","#ffffff"),document.querySelectorAll("body, h2, .label, .settings-title, #tagline, #openSettings, .back-button").forEach(e=>{e.style.color="#ffffff"}),document.querySelectorAll(".action-button, #enterPromptBtn, #editTextBtn, #bubbleModeBtn, #generatePromptBtn, #cancelPromptBtn").forEach(e=>{e.style.color="#ffffff",e.style.border="1px solid #ffffff"}),document.querySelectorAll(".action-button .span-mother span, .action-button .span-mother2 span").forEach(e=>{e.style.color="#ffffff"})):(document.documentElement.style.setProperty("--text-color",n),document.querySelectorAll("body, h2, .label, .settings-title, #tagline, #openSettings, .back-button").forEach(e=>{e.style.color=n}),document.querySelectorAll(".action-button, #enterPromptBtn, #editTextBtn, #bubbleModeBtn, #generatePromptBtn, #cancelPromptBtn").forEach(e=>{e.style.color="#ffffff",e.style.border="none"}),document.querySelectorAll(".action-button .span-mother span, .action-button .span-mother2 span").forEach(e=>{e.style.color="#ffffff"}))}chrome.storage.onChanged.addListener((e,t)=>{"local"===t&&e.theme&&n(e.theme.newValue)}),chrome.runtime.onMessage.addListener(e=>{"themeChanged"===e.type&&e.theme&&n(e.theme)});const o=document.getElementById("toolsView"),r=document.getElementById("buttons"),s={};function i(e){const t=document.getElementById("mimir-upgrade-modal");t&&(document.getElementById("mimir-upgrade-modal-msg").innerText=e||"This feature is limited to Pro users.",t.style.display="flex")}[{name:"Summarize",description:"Get a context-aware summary of the selected text."},{name:"Explain Like I'm 5",description:"Simplify the selected text so a 5-year-old could understand it."},{name:"Translate Text",description:"Translate selected or full-page text from any language into English."},{name:"Definition",description:"Define a selected word or phrase and optionally simplify it."},{name:"Turn Professional",description:"Polish informal writing into professional, work-ready prose."},{name:"Socratic Review",description:"Ask critical questions to clarify and challenge your thinking."},{name:"Daily Brief",description:"Summarize yesterday's notes, list tasks, and suggest what to work on."},{name:"Citation Finder",description:"Suggest sources or references related to the selected content."},{name:"Flashcard Generator",description:"Turn notes or articles into tab-separated, Anki-compatible flashcards."},{name:"Upload Image",description:"Upload an image to extract text and find answers."},{name:"AI Detector",description:"Detect if text was generated by AI or written by humans."}].forEach(t=>{const n=document.createElement("div");n.className="tool";const o=document.createElement("div");o.className="tool-header";const a=document.createElement("button");a.className="action-button",a.textContent=t.name,a.dataset.action=t.name;const c=document.createElement("div");c.className="description",c.textContent=t.description;const m=document.createElement("div");m.className="mimir-spinner",m.style.display="none",m.innerHTML='\n    <div class="loading-wave" style="display: flex; align-items: flex-end; justify-content: center;">\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n    </div>\n  ',o.appendChild(m),"Upload Image"===t.name?a.addEventListener("click",async()=>{const{allowed:e}=await l("Upload Image");if(!e)return void i("🔒 This tool is limited to one use per day for free users. Upgrade to Pro for unlimited access.");const t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",t.onchange=async()=>{if(!t.files||0===t.files.length)return;const e=t.files[0];m.style.display="block",o.classList.add("loading"),document.getElementById("result").innerText="Uploading and processing image...";try{const t=new FileReader;t.onload=function(e){const t=e.target.result;chrome.runtime.sendMessage({type:"proxy_api_request",payload:{url:"https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",method:"POST",body:{action:"Upload Image",imageData:t}}},e=>{if(chrome.runtime.lastError)d("Error: "+chrome.runtime.lastError.message,"Upload Image Error");else if(e&&e.success){const t=e.data;let n="";t.answers&&(n+="ANSWERS:\n"+t.answers+"\n\n"),t.ocrText&&(n+="EXTRACTED TEXT:\n"+t.ocrText),n||(n="No response from server."),d(n,"Upload Image Result")}else d("Error: "+(e?e.error:"No response"),"Upload Image Error")})},t.readAsDataURL(e)}catch(e){d("Error: "+e.message,"Upload Image Error")}finally{m.style.display="none",o.classList.remove("loading")}},document.body.appendChild(t),t.click(),t.remove()}):a.addEventListener("click",async()=>{const{allowed:n}=await l(t.name);n?(m.style.display="block",m.offsetWidth,o.classList.add("loading"),chrome.tabs.query({active:!0,currentWindow:!0},n=>{chrome.scripting.executeScript({target:{tabId:n[0].id},func:()=>window.getSelection().toString()},async r=>{let i=r[0]?.result?.trim();const a=t.name,l=!["Definition"].includes(a);if(i){s[a]=!1;try{const t=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e(a,i))}),n=t.headers.get("content-type");if(!n||!n.includes("application/json")){const e=await t.text();throw console.error("Non-JSON response received:",e.substring(0,200)),new Error("Server returned HTML instead of JSON. Please check if the server is running properly.")}const o=await t.json();d(o.result||o.error||"No response.",`${a} Result`)}catch(e){console.error("API request error:",e);let t="Error: "+e.message;e.message.includes("Failed to fetch")?t="Network error: Cannot connect to server. Please check your internet connection.":e.message.includes("HTML instead of JSON")&&(t="Server error: The API server may be down or misconfigured."),d(t,`${a} Error`)}finally{m.style.display="none",o.classList.remove("loading")}}else l?s[a]?chrome.scripting.executeScript({target:{tabId:n[0].id},func:()=>document.body.innerText},async t=>{const n=t[0]?.result?.trim();try{const t=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e(a,n))}),o=t.headers.get("content-type");if(!o||!o.includes("application/json")){const e=await t.text();throw console.error("Non-JSON response received:",e.substring(0,200)),new Error("Server returned HTML instead of JSON. Please try again.")}const r=await t.json();d(r.result||r.error||"No response.",`${a} Result`)}catch(e){console.error("API request error:",e),d("Error: "+e.message,`${a} Error`)}finally{m.style.display="none",o.classList.remove("loading")}}):(s[a]=!0,d(`Please select some text first or press again to ${a.toLowerCase()} the entire page.`,`${a} - No Text Selected`),m.style.display="none",o.classList.remove("loading")):(d("Please select some text first.",`${a} - No Text Selected`),m.style.display="none",o.classList.remove("loading"))})})):i("🔒 This tool is limited to one use per day for free users. Upgrade to Pro for unlimited access.")}),o.appendChild(a),n.appendChild(o),n.appendChild(c),r.appendChild(n)}),window.addEventListener("DOMContentLoaded",()=>{chrome.storage.local.get("theme",({theme:e})=>{n(e||"default")}),chrome.storage.local.get("isAdminMode",({isAdminMode:e})=>{e||async function(){try{const e=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"Turn Professional",text:"admin mode detection test"})});e.ok&&(await e.json(),console.log("🔥 Admin mode detection: Server response received, checking logs..."),chrome.storage.local.set({isAdminMode:!0}),console.log("🔥 CLIENT ADMIN MODE: Enabled based on server response"))}catch(e){console.log("🔥 Admin mode detection failed or not enabled:",e.message),chrome.storage.local.set({isAdminMode:!1})}}()});const e=document.getElementById("resultCloseBtn"),t=document.getElementById("resultPopup");e&&e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),m()}),t&&(t.addEventListener("click",e=>{e.target===t&&m()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&"flex"===t.style.display&&m()})),document.querySelectorAll("button").forEach(e=>{p(e)}),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length&&e.addedNodes.forEach(e=>{1===e.nodeType&&"BUTTON"===e.tagName&&p(e),1===e.nodeType&&e.querySelectorAll("button").forEach(e=>{p(e)})})})}).observe(document.body,{childList:!0,subtree:!0});const r=document.getElementById("themeSelector");r&&chrome.storage.local.get("theme",({theme:e})=>{e&&(r.value=e),r.addEventListener("change",()=>{const e=r.value;chrome.storage.local.set({theme:e},()=>{n(e),chrome.runtime.sendMessage({type:"themeChanged",theme:e}),chrome.runtime.sendMessage({type:"setIconByTheme",theme:e})})})});const s=document.getElementById("openSettings");s&&s.addEventListener("click",()=>{o.classList.remove("active"),o.classList.add("slide-in-right"),document.getElementById("settingsView").classList.add("active","slide-in-left")});const i=document.getElementById("backToTools");i&&i.addEventListener("click",()=>{!function(){const e=document.getElementById("settingsView");e.classList.remove("active"),e.classList.add("slide-in-right"),o.classList.remove("slide-in-right"),o.classList.add("active")}()});const a=document.getElementById("blinkSearch"),l=document.getElementById("blinkIcon"),f=(document.getElementById("blinkSpinner"),document.getElementById("result"));a&&l&&(l.addEventListener("click",()=>{c()}),a.addEventListener("keypress",e=>{"Enter"===e.key&&c()}));const y=document.getElementById("enterPromptBtn"),g=document.getElementById("editTextBtn"),b=document.getElementById("promptSection"),h=document.getElementById("generatePromptBtn"),x=document.getElementById("cancelPromptBtn"),E=document.getElementById("promptInput"),v=document.getElementById("editResponseBtn"),k=document.getElementById("buttons"),w=document.getElementById("topButtonsContainer"),S=document.getElementById("blinkSearchContainer");let B="";v&&(v.style.display="none"),g&&g.addEventListener("click",()=>{chrome.tabs.create({url:chrome.runtime.getURL("prompt-editor.html")})});const I=document.getElementById("bubbleModeBtn");if(I&&I.addEventListener("click",()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{e&&e[0]?(chrome.scripting.executeScript({target:{tabId:e[0].id},func:u}),window.close()):console.error("No active tab found for bubble mode injection")})}),y&&y.addEventListener("click",()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.scripting.executeScript({target:{tabId:e[0].id},func:()=>window.getSelection().toString()},e=>{const t=e[0]?.result?.trim()||"";b.style.display="block",k.style.display="none",f.innerText="",v.style.display="none",t&&(E.value=t),w&&(w.style.display="none"),S&&(S.style.display="none")})})}),x&&x.addEventListener("click",()=>{b.style.display="none",k.style.display="block",E.value="",g&&(g.style.display="block"),w&&(w.style.display="flex"),S&&(S.style.display="block")}),h&&h.addEventListener("click",async()=>{const e=E.value.trim();if(e){h.disabled=!0,h.textContent="Generating...";try{const n=!!((t=e).includes("A.")||t.includes("1.")||t.includes("option")||t.toLowerCase().includes("true")||t.toLowerCase().includes("false"))&&(/(?:\n|\r|\r\n|^)\s*[A-D][\.\)].*(?:\n|\r|\r\n)\s*[A-D][\.\)].*(?:\n|\r|\r\n)\s*[A-D][\.\)].*/i.test(t)||/(?:\n|\r|\r\n|^)\s*[1-4][\.\)].*(?:\n|\r|\r\n)\s*[1-4][\.\)].*(?:\n|\r|\r\n)\s*[1-4][\.\)].*/i.test(t)||/(?:\n|\r|\r\n|^)(?:.*)(?:true\s+or\s+false|true\/false)(?:.*?)(?:\?|\.)/i.test(t)),o=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:n?"Answer MCQ":"Essay Response",text:e,detailed:!0})}),r=o.headers.get("content-type");if(!r||!r.includes("application/json")){const e=await o.text();throw console.error("Non-JSON response received:",e.substring(0,200)),new Error("Server returned HTML instead of JSON. The API server may be experiencing issues.")}if(!o.ok){const e=await o.json().catch(()=>({error:`HTTP ${o.status}`}));throw new Error(e.error||`API error: ${o.status}`)}const s=await o.json(),i=s.result||s.error||"No response received from the server.";B=i,d(i,"Enter Prompt Result"),b.style.display="none",k.style.display="block",v&&(v.style.display="block"),w&&(w.style.display="flex"),S&&(S.style.display="block"),g&&(g.style.display="block")}catch(e){console.error("Generate prompt error:",e);let t=`Error: ${e.message}`;e.message.includes("Failed to fetch")?t="Network error: Cannot connect to server. Please check your internet connection and try again.":e.message.includes("HTML instead of JSON")&&(t="Server error: The API server is not responding correctly. Please try again later."),d(t+"\n\nPlease try again.","Enter Prompt Error")}finally{h.disabled=!1,h.textContent="Generate Response"}var t}else d("Please enter a prompt before generating a response.","Enter Prompt - No Text")}),v&&v.addEventListener("click",()=>{chrome.storage.local.set({promptEditorEditText:B||""},()=>{chrome.tabs.create({url:chrome.runtime.getURL("prompt-editor.html")})})}),E&&E.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),h.click())}),!document.getElementById("mimir-upgrade-modal-font")){const e=document.createElement("style");e.id="mimir-upgrade-modal-font",e.textContent="\n      @font-face {\n        font-family: 'RobotoCondensedMediumItalic';\n        src: url('RobotoCondensed-MediumItalic.ttf') format('truetype');\n        font-style: italic;\n        font-weight: normal;\n      }\n      #mimir-upgrade-modal, #mimir-upgrade-modal * {\n        font-family: 'RobotoCondensedMediumItalic', Arial, sans-serif !important;\n      }\n      #mimir-upgrade-modal .mimir-upgrade-modal-content {\n        font-style: normal !important;\n      }\n      #mimir-upgrade-modal-close {\n        transition: none !important;\n        background: none !important;\n        color: #aaa !important;\n        border: none !important;\n        font-size: 13px !important;\n        cursor: pointer !important;\n        font-style: normal !important;\n        padding: 0 !important;\n        margin: 0 !important;\n        box-shadow: none !important;\n        outline: none !important;\n        line-height: 1.2 !important;\n        vertical-align: middle !important;\n        position: static !important;\n        min-width: 0 !important;\n        min-height: 0 !important;\n        height: auto !important;\n      }\n      #mimir-upgrade-modal-close:hover {\n        color: #aaa !important;\n        background: none !important;\n        transform: none !important;\n        box-shadow: none !important;\n        outline: none !important;\n        position: static !important;\n        top: auto !important;\n        left: auto !important;\n      }\n    ",document.head.appendChild(e)}if(!document.getElementById("mimir-upgrade-modal")){const e=document.createElement("div");e.id="mimir-upgrade-modal",e.style.cssText="\n      display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh;\n      background: rgba(0,0,0,0.45); justify-content: center; align-items: center;\n    ",e.innerHTML='\n      <div class="mimir-upgrade-modal-content" style="\n        background: #232323; color: #fff; border-radius: 10px; padding: 28px 24px 20px 24px; min-width: 260px; max-width: 340px; box-shadow: 0 8px 32px #0008; text-align: center; position: relative; font-style: normal;">\n        <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px; font-style: normal;">Upgrade to Mimir Pro</div>\n        <div id="mimir-upgrade-modal-msg" style="font-size: 15px; margin-bottom: 18px; font-style: normal;"></div>\n        <a id="mimir-upgrade-modal-btn" href="https://mimir-server-daemosthene-vercel.app/api/create-checkout" target="_blank"\n          style="display: inline-block; background: var(--accent-color,#4287f5); color: #fff; font-weight: bold; padding: 8px 18px; border-radius: 5px; text-decoration: none; font-size: 15px; margin-bottom: 10px; font-style: normal;">\n          Go Pro\n        </a>\n        <br>\n      </div>\n    ',document.body.appendChild(e),e.addEventListener("click",t=>{t.target===e&&(e.style.display="none")})}});const a=["Turn Professional","Socratic Review","Daily Brief","Citation Finder","Flashcard Generator","Upload Image","Enter Prompt","Blink","AI Detector"];function l(e){return new Promise(t=>{chrome.storage.local.get(["isProUser","usage","isAdminMode"],({isProUser:n,usage:o,isAdminMode:r})=>{if(r)return console.log("🔥 CLIENT ADMIN MODE: Bypassing usage restrictions for",e),t({allowed:!0});if(n)return t({allowed:!0});const s=(new Date).toISOString().split("T")[0],i=(o=o||{})[s]||{};if(a.includes(e)){const n=i[e]||0;n<1?(i[e]=n+1,o[s]=i,chrome.storage.local.set({usage:o},()=>t({allowed:!0}))):t({allowed:!1})}else t({allowed:!0})})})}async function c(){const e=document.getElementById("blinkSearch"),t=document.getElementById("blinkSpinner"),n=document.querySelector(".input-container"),o=e.value.trim();if(!o)return void d("Please enter a question.","Blink - No Question");const{allowed:r}=await l("Blink");if(r){t.style.display="block",n.classList.add("with-spinner");try{const e=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"Blink",text:o,maxWords:25,concise:!0})}),t=e.headers.get("content-type");if(!t||!t.includes("application/json")){const t=await e.text();throw console.error("Blink non-JSON response:",t.substring(0,200)),new Error("Server returned HTML instead of JSON")}if(!e.ok)throw new Error(`API request failed with status ${e.status}`);const n=await e.json();n.result?d(n.result,"Blink Result"):n.error?d(`Error: ${n.error}`,"Blink Error"):d("No answer found.","Blink Result")}catch(e){console.error("Blink search error:",e);let t="Error: Could not get an answer.";e.message.includes("Failed to fetch")?t="Network error: Cannot connect to server. Please check your connection.":e.message.includes("HTML instead of JSON")&&(t="Server error: API server is not responding correctly."),d(t+" Please try again.","Blink Error")}finally{t.style.display="none",n.classList.remove("with-spinner")}}else i("🔒 Blink is limited to one use per day for free users. Upgrade to Pro for unlimited access.")}function d(e,t="Mimir Result"){const n=document.getElementById("resultPopup"),o=document.getElementById("resultPopupText"),r=document.querySelector(".result-header");if(n&&o){r.textContent=t,o.textContent=e,n.style.display="flex",n.focus();const s=document.getElementById("resultCloseBtn");s&&(s.replaceWith(s.cloneNode(!0)),document.getElementById("resultCloseBtn").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),m()}))}}function m(){const e=document.getElementById("resultPopup");e&&(e.style.display="none")}function p(e){if(e.querySelector(".span-mother"))return;if(e.classList.contains("toggle-description"))return;if("enterPromptBtn"===e.id||"editTextBtn"===e.id||"editResponseBtn"===e.id||"bubbleModeBtn"===e.id||"openSettings"===e.id||"generatePromptBtn"===e.id||"cancelPromptBtn"===e.id||"backToTools"===e.id)return;const t=e.textContent.trim();e.dataset.originalText=t;const n=window.getComputedStyle(e),o=n.fontFamily,r=n.fontSize,s=n.fontWeight,i=n.color,a=document.createElement("span");a.className="span-mother",a.style.fontFamily=o,a.style.fontSize=r,a.style.fontWeight=s,a.style.color=i;const l=document.createElement("span");l.className="span-mother2",l.style.fontFamily=o,l.style.fontSize=r,l.style.fontWeight=s,l.style.color=i;const c="enterPromptBtn"===e.id||"editTextBtn"===e.id;Array.from(t).forEach(e=>{const t=document.createElement("span");t.textContent=" "===e?" ":e,t.style.fontFamily=o,t.style.fontSize=r,t.style.fontWeight=s,t.style.color=i,c&&(t.style.transform="none"),a.appendChild(t);const n=document.createElement("span");n.textContent=" "===e?" ":e,n.style.fontFamily=o,n.style.fontSize=r,n.style.fontWeight=s,n.style.color=i,c&&(n.style.transform="none"),l.appendChild(n)}),e.textContent="",e.appendChild(a),e.appendChild(l)}function u(){document.getElementById("mimir-detached-bubble")||chrome.storage.local.get("theme",({theme:e})=>{const t={default:"#4287f5",red:"#A4262C",orange:"#CA5010",darkblue:"#40587C",green:"#407855",purple:"#8764B8",teal:"#038387",yellow:"#CEA230",white:"#ffffff",black:"#000000"},n=t[e||"default"]||t.default,o=document.createElement("div");o.id="mimir-detached-bubble";const r=[{name:"Summarize",icon:"📄",description:"Get a context-aware summary of the selected text."},{name:"Explain Like I'm 5",icon:"🧒",description:"Simplify the selected text so a 5-year-old could understand it."},{name:"Translate Text",icon:"🌐",description:"Translate selected or full-page text from any language into English."},{name:"Definition",icon:"📖",description:"Define a selected word or phrase and optionally simplify it."},{name:"Turn Professional",icon:"💼",description:"Polish informal writing into professional, work-ready prose."},{name:"Socratic Review",icon:"🤔",description:"Ask critical questions to clarify and challenge your thinking."},{name:"Daily Brief",icon:"📅",description:"Summarize yesterday's notes, list tasks, and suggest what to work on."},{name:"Citation Finder",icon:"📚",description:"Suggest sources or references related to the selected content."},{name:"Flashcard Generator",icon:"🎴",description:"Turn notes or articles into tab-separated, Anki-compatible flashcards."},{name:"Upload Image",icon:"📷",description:"Upload an image to extract text and find answers."},{name:"Enter Prompt",icon:"📝",description:"Enter a custom prompt for AI processing."},{name:"Blink",icon:"⚡",description:"Get quick answers to your questions."},{name:"AI Detector",icon:"🤖",description:"Detect if text was generated by AI or written by humans."}].map((e,t)=>`\n      <div class="bubble-tool-btn" data-tool="${e.name}" style="\n        position: absolute;\n        width: 40px;\n        height: 40px;\n        background-color: ${n};\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        font-size: 18px;\n        user-select: none;\n        ${function(e){return 12===e?"left: 112px; top: 99.5px;":`left: ${e%6*46-3}px; top: ${52*Math.floor(e/6)-4.5}px;`}(t)}\n        ${"Upload Image"===e.name?"line-height: 1;":""}\n        ${"#000000"===n?"border: 1px solid #ffffff; color: #ffffff;":""}\n        ${"#ffffff"===n?"color: #000000;":""}\n      " title="${e.name}: ${e.description}">\n        ${e.icon}\n      </div>\n    `).join("");o.innerHTML=`\n      <div style="\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        width: 300px;\n        min-height: 210px;\n        max-height: 310px;\n        background-color: #2a2a2a;\n        border: 2px solid ${n};\n        border-radius: 15px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n        padding: 18px;\n        box-sizing: border-box;\n        z-index: 999999;\n        font-family: Arial, sans-serif;\n        cursor: grab;\n        user-select: none;\n        display: flex;\n        flex-direction: column;\n      " id="mimir-bubble-content">\n        <button style="\n          position: absolute;\n          top: 10px;\n          right: 15px;\n          background: none;\n          border: none;\n          font-size: 20px;\n          color: #999;\n          cursor: pointer;\n          font-family: Arial, sans-serif;\n          transition: color 0.2s ease;\n          z-index: 10;\n        " id="mimir-close-bubble">&times;</button>\n        \n        <div style="\n          font-size: 18px;\n          font-weight: bold;\n          color: ${"#ffffff"===n?"#ffffff":n};\n          margin-bottom: 15px;\n          font-family: Arial, sans-serif;\n          text-align: center;\n          flex-shrink: 0;\n        ">Bubble Mode</div>\n        \n        <div style="\n          position: relative;\n          flex: 1;\n          min-height: 135px;\n          display: flex;\n          justify-content: center;\n          align-items: center;\n        ">\n          ${r}\n        </div>\n        \n        <div id="bubble-result" style="\n          margin-top: 10px;\n          padding: 8px 20px 8px 8px;\n          font-size: 14px;\n          color: #fff;\n          font-family: Arial, sans-serif;\n          background: rgba(42, 42, 42, 0.8);\n          border: 1px solid ${n.replace("#","rgba(").replace(/^rgba\(/,"").replace(")",", 0.3)")};\n          border-radius: 5px;\n          display: none;\n          max-height: 80px;\n          overflow-y: auto;\n          flex-shrink: 0;\n          word-wrap: break-word;\n          line-height: 1.3;\n          position: relative;\n          backdrop-filter: blur(5px);\n          scrollbar-width: thin;\n          scrollbar-color: ${n.replace("#","rgba(").replace(/^rgba\(/,"").replace(")",", 0.6)")} rgba(42, 42, 42, 0.3);\n        ">\n          <style>\n            #bubble-result::-webkit-scrollbar {\n              width: 8px;\n            }\n            #bubble-result::-webkit-scrollbar-track {\n              background: rgba(42, 42, 42, 0.3);\n              border-radius: 4px;\n            }\n            #bubble-result::-webkit-scrollbar-thumb {\n              background: ${n.replace("#","rgba(").replace(/^rgba\(/,"").replace(")",", 0.6)")};\n              border-radius: 4px;\n            }\n            #bubble-result::-webkit-scrollbar-thumb:hover {\n              background: ${n.replace("#","rgba(").replace(/^rgba\(/,"").replace(")",", 0.8)")};\n            }\n          </style>\n          <button style="\n            position: absolute;\n            top: 2px;\n            right: 4px;\n            background: none;\n            border: none;\n            font-size: 16px;\n            color: #ccc;\n            cursor: pointer;\n            font-family: Arial, sans-serif;\n            padding: 0;\n            line-height: 1;\n          " id="bubble-result-close">&times;</button>\n        </div>\n      </div>\n    `,document.body.appendChild(o);const s=document.getElementById("mimir-bubble-content"),i=document.getElementById("mimir-close-bubble"),a=document.getElementById("bubble-result"),l=document.getElementById("bubble-result-close");i.addEventListener("click",()=>{o.remove()}),l.addEventListener("click",e=>{e.stopPropagation(),a.style.display="none"}),i.addEventListener("mouseenter",()=>{i.style.color="#fff"}),i.addEventListener("mouseleave",()=>{i.style.color="#999"}),l.addEventListener("mouseenter",()=>{l.style.color="#fff"}),l.addEventListener("mouseleave",()=>{l.style.color="#ccc"}),chrome.runtime.onMessage.addListener(e=>{"themeChanged"===e.type&&e.theme&&function(e){const n=t[e]||t.default,r=document.getElementById("mimir-bubble-content"),s=r.querySelector('div[style*="color"]'),i=document.getElementById("bubble-result"),a=o.querySelectorAll(".bubble-tool-btn");r.style.borderColor=n,s&&(s.style.color="#ffffff"===n?"#ffffff":n),i&&(i.style.borderColor=n.replace("#","rgba(").replace(/^rgba\(/,"").replace(")",", 0.3)")),a.forEach(e=>{e.style.backgroundColor=n,"#000000"===n?(e.style.border="1px solid #ffffff",e.style.color="#ffffff"):"#ffffff"===n?(e.style.border="none",e.style.color="#000000"):(e.style.border="none",e.style.color="#ffffff")})}(e.theme)}),o.querySelectorAll(".bubble-tool-btn").forEach(e=>{e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.1)";const t=getComputedStyle(document.documentElement).getPropertyValue("--accent-color").trim()||n,o=t+"dd";e.style.backgroundColor=o,"#000000"===t&&(e.style.border="1px solid #ffffff")}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)";const t=getComputedStyle(document.documentElement).getPropertyValue("--accent-color").trim()||n;e.style.backgroundColor=t,"#000000"===t&&(e.style.border="1px solid #ffffff")}),e.addEventListener("click",async t=>{t.stopPropagation();const n=e.dataset.tool;a.style.display="block",a.innerHTML=`\n          <button style="\n            position: absolute;\n            top: 2px;\n            right: 4px;\n            background: none;\n            border: none;\n            font-size: 16px;\n            color: #ccc;\n            cursor: pointer;\n            font-family: Arial, sans-serif;\n            padding: 0;\n            line-height: 1;\n          " id="bubble-result-close">&times;</button>\n          Processing ${n}...\n        `;const o=document.getElementById("bubble-result-close");o&&(o.addEventListener("click",e=>{e.stopPropagation(),a.style.display="none"}),o.addEventListener("mouseenter",()=>{o.style.color="#fff"}),o.addEventListener("mouseleave",()=>{o.style.color="#ccc"}));try{"Upload Image"===n?await async function(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",e.onchange=async()=>{if(!e.files||0===e.files.length)return;const t=e.files[0];y("Uploading and processing image...");try{const e=new FileReader;e.onload=function(e){const t=e.target.result;chrome.runtime.sendMessage({type:"proxy_api_request",payload:{url:"https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",method:"POST",body:{action:"Upload Image",imageData:t}}},e=>{if(chrome.runtime.lastError)y(`Error: ${chrome.runtime.lastError.message}`);else if(e&&e.success){const t=e.data;let n="";t.answers&&(n+="ANSWERS:\n"+t.answers+"\n\n"),t.ocrText&&(n+="EXTRACTED TEXT:\n"+t.ocrText),n||(n="No response from server."),y(n)}else y(`Error: ${e?e.error:"No response"}`)})},e.readAsDataURL(t)}catch(e){y(`Error: ${e.message}`)}},document.body.appendChild(e),e.click(),e.remove()}():"Enter Prompt"===n?function(e){y('\n        <div style="margin-bottom: 8px;">\n          <textarea id="prompt-input" placeholder="Enter your prompt or question..." style="\n            width: 100%;\n            min-height: 60px;\n            padding: 6px 8px;\n            border: 1px solid rgba(66, 135, 245, 0.5);\n            background: rgba(42, 42, 42, 0.9);\n            color: #fff;\n            border-radius: 3px;\n            font-size: 12px;\n            font-family: Arial, sans-serif;\n            resize: vertical;\n            box-sizing: border-box;\n            margin-bottom: 6px;\n          "></textarea>\n          <div style="display: flex; gap: 4px;">\n            <button id="prompt-submit" style="\n              flex: 1;\n              padding: 4px 8px;\n              background: rgba(66, 135, 245, 0.8);\n              color: #fff;\n              border: none;\n              border-radius: 3px;\n              cursor: pointer;\n              font-size: 12px;\n              font-family: Arial, sans-serif;\n            ">Generate</button>\n            <button id="prompt-cancel" style="\n              flex: 1;\n              padding: 4px 8px;\n              background: rgba(85, 85, 85, 0.8);\n              color: #fff;\n              border: none;\n              border-radius: 3px;\n              cursor: pointer;\n              font-size: 12px;\n              font-family: Arial, sans-serif;\n            ">Cancel</button>\n          </div>\n        </div>\n      ');const t=document.getElementById("prompt-input"),n=document.getElementById("prompt-submit"),o=document.getElementById("prompt-cancel");t&&t.focus(),n&&n.addEventListener("click",async()=>{const e=t.value.trim();if(!e)return;y("Processing prompt...");const n=function(e){if(!(e.includes("A.")||e.includes("1.")||e.includes("option")||e.toLowerCase().includes("true")||e.toLowerCase().includes("false")))return!1;return/(?:\n|\r|\r\n|^)\s*[A-D][\.\)].*(?:\n|\r|\r\n)\s*[A-D][\.\)].*(?:\n|\r|\r\n)\s*[A-D][\.\)].*/i.test(e)||/(?:\n|\r|\r\n|^)\s*[1-4][\.\)].*(?:\n|\r|\r\n)\s*[1-4][\.\)].*(?:\n|\r|\r\n)\s*[1-4][\.\)].*/i.test(e)||/(?:\n|\r|\r\n|^)(?:.*)(?:true\s+or\s+false|true\/false)(?:.*?)(?:\?|\.)/i.test(e)}(e);chrome.runtime.sendMessage({type:"proxy_api_request",payload:{url:"https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",method:"POST",body:{action:n?"Answer MCQ":"Essay Response",text:e,detailed:!0}}},e=>{if(chrome.runtime.lastError)y(`Error: ${chrome.runtime.lastError.message}`);else if(e&&e.success){const t=e.data;y(t.result||t.error||"No response received from the server.")}else y(`Error: ${e?e.error:"No response"}`)})}),o&&o.addEventListener("click",()=>{e.style.display="none"}),t&&t.addEventListener("keydown",e=>{"Enter"===e.key&&e.ctrlKey&&n.click()})}(a):"Blink"===n?function(){y('\n        <div style="margin-bottom: 8px;">\n          <div style="position: relative; width: 100%;">\n            <input type="text" id="blink-input" placeholder="Blink: Ask for a quick answer..." style="\n              width: 100%;\n              height: 26px;\n              padding: 4px 30px 4px 10px;\n              border: 2px solid #444;\n              background-color: #333;\n              color: #fff;\n              font-size: 12px;\n              letter-spacing: 1px;\n              border-radius: 4px;\n              box-sizing: border-box;\n              transition: border 0.2s linear, box-shadow 0.2s linear;\n            ">\n            <span style="\n              position: absolute;\n              right: 8px;\n              top: 50%;\n              transform: translateY(-50%);\n              cursor: pointer;\n            " id="blink-submit-icon">⚡</span          </div>\n        </div>\n      ');const e=document.getElementById("blink-input"),t=document.getElementById("blink-submit-icon");e&&e.focus();const n=async()=>{const t=e.value.trim();t&&(y("Processing Blink question..."),chrome.runtime.sendMessage({type:"proxy_api_request",payload:{url:"https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",method:"POST",body:{action:"Blink",text:t,maxWords:25,concise:!0}}},e=>{if(chrome.runtime.lastError)y(`Error: ${chrome.runtime.lastError.message}`);else if(e&&e.success){const t=e.data;let n="";n=t.result?t.result:t.error?`Error: ${t.error}`:"No answer found.",y(n)}else y(`Error: ${e?e.error:"No response"}`)}))};t&&t.addEventListener("click",n),e&&(e.addEventListener("keypress",e=>{"Enter"===e.key&&n()}),e.addEventListener("focus",()=>{e.style.border="0.5px solid #4287f5",e.style.boxShadow="-3px -3px 0px #4287f5",e.style.outline="none"}),e.addEventListener("blur",()=>{e.style.border="2px solid #444",e.style.boxShadow="none"}))}():await async function(e){let t=window.getSelection().toString().trim();const n=!["Definition"].includes(e);if(!t&&n){if(t=document.body.innerText.trim(),!t)return void y("No text found on this page.")}else if(!t)return void y("Please select some text first.");y(`Processing ${e}...`);try{chrome.runtime.sendMessage({type:"proxy_api_request",payload:{url:"https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",method:"POST",body:f(e,t)}},e=>{if(chrome.runtime.lastError)y(`Error: ${chrome.runtime.lastError.message}`);else if(e&&e.success){const t=e.data;y(t.result||t.error||"No response received from the server.")}else y(`Error: ${e?e.error:"No response"}`)})}catch(e){console.error("Tool error:",e),y(`Error: ${e.message}`)}}(n)}catch(e){a.innerHTML=`\n            <button style="\n              position: absolute;\n              top: 2px;\n              right: 4px;\n              background: none;\n              border: none;\n              font-size: 16px;\n              color: #ccc;\n              cursor: pointer;\n              font-family: Arial, sans-serif;\n              padding: 0;\n              line-height: 1;\n            " id="bubble-result-close">&times;</button>\n            Error: ${e.message}\n          `}})});let c,d,m,p,u=!1;function f(e,t){const n={action:e,text:t};switch(e){case"Summarize":return{...n,mode:"concise",includeKeywords:!0};case"Explain Like I'm 5":return{...n,simplifyLevel:5};case"Citation Finder":return{...n,includeLinks:!0,format:"APA"};case"Definition":return{...n,includeExamples:!0,simplify:!0};case"Daily Brief":return{...n,context:"yesterday",includeTasks:!0};case"Socratic Review":return{...n,questionStyle:"dialectic",depth:"high"};case"Flashcard Generator":return{...n,format:"anki",maxCards:10};case"Turn Professional":return{...n,tone:"professional",polish:!0};case"Translate Text":return{...n,targetLanguage:"en",preserveFormat:!0};case"AI Detector":return{...n,detectAI:!0};default:return n}}function y(e){a.style.display="block",a.innerHTML=`\n        <button style="\n          position: absolute;\n          top: 2px;\n          right: 4px;\n          background: none;\n          border: none;\n          font-size: 16px;\n          color: #ccc;\n          cursor: pointer;\n          font-family: Arial, sans-serif;\n          padding: 0;\n          line-height: 1;\n        " id="bubble-result-close">&times;</button>\n        ${e}\n      `;const t=document.getElementById("bubble-result-close");t&&(t.addEventListener("click",e=>{e.stopPropagation(),a.style.display="none"}),t.addEventListener("mouseenter",()=>{t.style.color="#fff"}),t.addEventListener("mouseleave",()=>{t.style.color="#ccc"}))}s.addEventListener("mousedown",function(e){if(e.target===i||e.target===l)return;if(e.target.classList.contains("bubble-tool-btn"))return;u=!0,c=e.clientX,d=e.clientY;const t=s.getBoundingClientRect();m=t.left,p=t.top,s.style.position="fixed",s.style.left=m+"px",s.style.top=p+"px",s.style.width="300px",s.style.height="210px",s.style.minHeight="210px",s.style.maxHeight="310px",s.style.cursor="grabbing"}),document.addEventListener("mousemove",function(e){if(!u)return;const t=e.clientX-c,n=e.clientY-d;let o=m+t,r=p+n;const i=window.innerWidth-300-10,a=window.innerHeight-s.offsetHeight-10;o<10&&(o=10),r<10&&(r=10),o>i&&(o=i),r>a&&(r=a),s.style.left=o+"px",s.style.top=r+"px"}),document.addEventListener("mouseup",function(){u=!1,s.style.cursor="grab"})})}document.body.addEventListener("click",async e=>{if(e.target.closest("#mimir-upgrade-modal-btn")){e.preventDefault();try{const e=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/create-checkout",{method:"POST"}),t=await e.json();t.url&&t.sessionId?(chrome.storage.local.set({checkoutSessionId:t.sessionId}),window.open(t.url,"_blank")):t.url&&window.open(t.url,"_blank")}catch(e){alert("Failed to start checkout: "+e.message)}}}),chrome.storage.local.get("checkoutSessionId",({checkoutSessionId:e})=>{e&&async function(e){try{const t=await fetch(`https://mimir-server-daemosthene-mimir-extension.vercel.app/api/verify-subscription?sessionId=${e}`),{status:n}=await t.json(),o="active"===n;chrome.storage.local.set({isProUser:o})}catch(e){}}(e)})})();