(()=>{function e(e,t){const n={action:e,text:t};switch(e){case"Summarize":return{...n,mode:"concise",includeKeywords:!0};case"Explain Like I'm 5":return{...n,simplifyLevel:5};case"Citation Finder":return{...n,includeLinks:!0,format:"APA"};case"Definition":return{...n,includeExamples:!0,simplify:!0};case"Daily Brief":return{...n,context:"yesterday",includeTasks:!0};case"Socratic Review":return{...n,questionStyle:"dialectic",depth:"high"};case"Flashcard Generator":return{...n,format:"anki",maxCards:10};case"Turn Professional":return{...n,tone:"professional",polish:!0};case"Translate Text":return{...n,targetLanguage:"en",preserveFormat:!0};default:return n}}document.getElementById("toolsView");const t=document.getElementById("buttons"),n={};[{name:"Summarize",description:"Get a context-aware summary of the selected text."},{name:"Explain Like I'm 5",description:"Simplify the selected text so a 5-year-old could understand it."},{name:"Translate Text",description:"Translate selected or full-page text from any language into English."},{name:"Definition",description:"Define a selected word or phrase and optionally simplify it."},{name:"Turn Professional",description:"Polish informal writing into professional, work-ready prose."},{name:"Socratic Review",description:"Ask critical questions to clarify and challenge your thinking."},{name:"Daily Brief",description:"Summarize yesterday's notes, list tasks, and suggest what to work on."},{name:"Citation Finder",description:"Suggest sources or references related to the selected content."},{name:"Flashcard Generator",description:"Turn notes or articles into tab-separated, Anki-compatible flashcards."},{name:"Upload Image",description:"Upload an image to extract text and find answers."}].forEach(r=>{const s=document.createElement("div");s.className="tool";const o=document.createElement("div");o.className="tool-header";const a=document.createElement("button");a.className="action-button",a.textContent=r.name,a.dataset.action=r.name;const i=document.createElement("div");i.className="description",i.textContent=r.description;const c=document.createElement("div");c.className="mimir-spinner",c.style.display="none",c.innerHTML='\n    <div class="loading-wave" style="display: flex; align-items: flex-end; justify-content: center;">\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n      <div class="loading-bar" style="display: block; background-color: var(--accent-color);"></div>\n    </div>\n  ',o.appendChild(c),"Upload Image"===r.name?a.addEventListener("click",async()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",e.onchange=async()=>{if(!e.files||0===e.files.length)return;const t=e.files[0];c.style.display="block",o.classList.add("loading"),document.getElementById("result").innerText="Uploading and processing image...";try{const e=new FormData;e.append("image",t);const n=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",body:e}),r=n.headers.get("content-type");if(!r||!r.includes("application/json")){const e=await n.text();throw console.error("Upload non-JSON response:",e.substring(0,200)),new Error("Server returned HTML instead of JSON. API server may be down.")}if(!n.ok){const e=await n.json().catch(()=>({error:`HTTP ${n.status}`}));throw new Error(e.error||`API error: ${n.status}`)}const s=await n.json();let o="";s.answers&&(o+="ANSWERS:\n"+s.answers+"\n\n"),s.ocrText&&(o+="EXTRACTED TEXT:\n"+s.ocrText),o||(o="No response from server."),document.getElementById("result").innerText=o}catch(e){console.error("Upload error:",e);let t="Error: "+e.message;e.message.includes("Failed to fetch")?t="Network error: Cannot connect to server. Please check your connection.":e.message.includes("HTML instead of JSON")&&(t="Server error: API server is not responding correctly."),document.getElementById("result").innerText=t}finally{c.style.display="none",o.classList.remove("loading")}},document.body.appendChild(e),e.click(),e.remove()}):a.addEventListener("click",async()=>{c.style.display="block",c.offsetWidth,o.classList.add("loading"),chrome.tabs.query({active:!0,currentWindow:!0},t=>{chrome.scripting.executeScript({target:{tabId:t[0].id},func:()=>window.getSelection().toString()},async s=>{let a=s[0]?.result?.trim();const i=r.name,l=!["Definition"].includes(i);if(a){n[i]=!1;try{const t=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e(i,a))}),n=t.headers.get("content-type");if(!n||!n.includes("application/json")){const e=await t.text();throw console.error("Non-JSON response:",e.substring(0,200)),new Error("Server returned HTML instead of JSON. Please check server status.")}const r=await t.json();document.getElementById("result").innerText=r.result||r.error||"No response."}catch(e){console.error("API request error:",e);let t="Error: "+e.message;e.message.includes("Failed to fetch")?t="Network error: Cannot connect to server. Please check your internet connection.":e.message.includes("HTML instead of JSON")&&(t="Server error: The API server may be down or misconfigured."),document.getElementById("result").innerText=t}finally{c.style.display="none",o.classList.remove("loading")}}else l?n[i]?chrome.scripting.executeScript({target:{tabId:t[0].id},func:()=>document.body.innerText},async t=>{const n=t[0]?.result?.trim();try{const t=await fetch("https://mimir-server-daemosthene-mimir-extension.vercel.app/api/mimir",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e(i,n))}),r=t.headers.get("content-type");if(!r||!r.includes("application/json")){const e=await t.text();throw console.error("Non-JSON response:",e.substring(0,200)),new Error("Server returned HTML instead of JSON. Please try again.")}const s=await t.json();document.getElementById("result").innerText=s.result||s.error||"No response."}catch(e){console.error("API request error:",e);let t="Error: "+e.message;e.message.includes("Failed to fetch")?t="Network error: Cannot connect to server. Please check your connection.":e.message.includes("HTML instead of JSON")&&(t="Server error: The API server may be down. Please try again later."),document.getElementById("result").innerText=t}finally{c.style.display="none",o.classList.remove("loading")}}):(n[i]=!0,document.getElementById("result").innerText=`Please select some text first or press again to ${i.toLowerCase()} the entire page.`,c.style.display="none",o.classList.remove("loading")):(document.getElementById("result").innerText="Please select some text first.",c.style.display="none",o.classList.remove("loading"))})})}),o.appendChild(a),s.appendChild(o),s.appendChild(i),t.appendChild(s)})})();